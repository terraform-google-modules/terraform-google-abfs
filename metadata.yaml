# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: blueprints.cloud.google.com/v1alpha1
kind: BlueprintMetadata
metadata:
  name: abfs_deploy_cos
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  info:
    title: Deploy ABFS in containers on GCE VMs
    source:
      repo: https://android-keystone-os.googlesource.com/abfs_deploy_cos
      sourceType: git
      dir: /server
    description: {}
  content: {}
  interfaces:
    variables:
      - name: project_id
        description: Google Cloud project ID
        varType: string
        required: true
      - name: zone
        description: Zone for ABFS servers
        varType: string
        required: true
        defaultValue: us-central1-a
      - name: subnetwork
        description: Subnetwork for the servers
        varType: string
        required: true
        defaultValue: projects/jbrook-abfs-playground/regions/us-central1/subnetworks/network #FIXME
      - name: service_account_email
        description: Email of service account to attach to the servers
        varType: string
        required: true
      - name: abfs_server_machine_type
        description: Machine type for ABFS servers
        varType: string
        defaultValue: n2-highmem-128
      - name: abfs_server_name
        description: Name for the ABFS server
        varType: string
        defaultValue: abfs-server
      - name: abfs_server_cos_image_ref
        description: Reference to the COS boot image to use for the ABFS server
        varType: string
        defaultValue: projects/jbrook-abfs-playground/global/images/abfs-vmcos109-image-x8664-20250204
      - name: abfs_datadisk_type
        description: The PD regional disk type to use for the ABFS datadisk
        varType: string
        defaultValue: pd-ssd
      - name: abfs_datadisk_name
        description: A name for the ABFS datadisk that will be attached to the VM. Note, this does not affect the mounting of the disk - the device name is always set to "abfs-server-storage"
        varType: string
        defaultValue: abfs-datadisk
      - name: abfs_datadisk_size_gb
        description: Size in GB for the ABFS datadisk that will be attached to the VM
        varType: number
        defaultValue: 10000
      - name: abfs_docker_image_uri
        description: Docker image URI for main ABFS server
        varType: string
        required: true
        defaultValue: us-docker.pkg.dev/jbrook-abfs-playground/abfs-docker-repo/abfs:latest # FIXME
      - name: abfs_server_command
        description: The ABFS command to run on ABFS servers. The command should not include 'abfs', only what follows
        varType: string
        defaultValue: server -d /abfs-storage
      - name: abfs_datadisk_mountpoint
        description: Location for mounting the ABFS datadisk on the host VM
        varType: string
        defaultValue: /mnt/disks/abfs-data
      - name: abfs_gerrit_uploader_count
        description: The number of gerrit uploader instances to create
        varType: number
        defaultValue: 3
      - name: abfs_gerrit_uploader_machine_type
        description: Machine type for ABFS gerrit uploaders
        varType: string
        defaultValue: n2d-standard-48
      - name: abfs_gerrit_uploader_name_prefix
        description: Name prefix for the ABFS gerrit uploader VM(s)
        varType: string
        defaultValue: abfs-gerrit-uploader
      - name: abfs_gerrit_uploader_datadisk_name_prefix
        description: A name prefix for the ABFS gerrit uploader datadisk(s) that will be attached to VM(s). Note, this does not affect the mounting of the disk - the device name is always set to "abfs-server-storage"
        varType: string
        defaultValue: abfs-gerrit-uploader-datadisk
      - name: abfs_gerrit_uploader_datadisk_size_gb
        description: Size in GB for the ABFS gerrit uploader datadisk(s) that will be attached to the VM(s)
        varType: number
        defaultValue: 4096
      - name: abfs_gerrit_uploader_datadisk_type
        description: The PD regional disk type to use for the ABFS gerrit uploader datadisk(s)
        varType: string
        defaultValue: pd-ssd
      - name: abfs_gerrit_uploader_git_servers
        description: List of git servers to upload to the ABFS server (e.g. ["android.googlesource.com"])
        varType: list(string)
        required: true
        defaultValue: ["android.googlesource.com"]
      - name: abfs_gerrit_uploader_git_branch
        description: Git branch to upload to the ABFS server (e.g.main)
        varType: string
        defaultValue: main
      - name: goog_cm_deployment_name
        description: The name of the deployment and VM instance.
        varType: string
        required: true
